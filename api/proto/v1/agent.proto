syntax = "proto3";

package netctrl.v1;

option go_package = "github.com/mfilanov/netctrl-server/pkg/api/v1;v1";

import "google/api/annotations.proto";
import "google/protobuf/timestamp.proto";

// AgentService provides operations for agent registration and management
service AgentService {
  // RegisterAgent registers or updates an agent to a cluster
  rpc RegisterAgent(RegisterAgentRequest) returns (RegisterAgentResponse) {
    option (google.api.http) = {
      post: "/api/v1/agents/register"
      body: "*"
    };
  }

  // GetAgent retrieves an agent by ID
  rpc GetAgent(GetAgentRequest) returns (GetAgentResponse) {
    option (google.api.http) = {
      get: "/api/v1/agents/{id}"
    };
  }

  // ListAgents lists all agents, optionally filtered by cluster
  rpc ListAgents(ListAgentsRequest) returns (ListAgentsResponse) {
    option (google.api.http) = {
      get: "/api/v1/agents"
    };
  }

  // UnregisterAgent removes an agent
  rpc UnregisterAgent(UnregisterAgentRequest) returns (UnregisterAgentResponse) {
    option (google.api.http) = {
      delete: "/api/v1/agents/{id}"
    };
  }

  // GetInstructions polls for pending instructions
  // This serves as instruction delivery and implicit healthcheck
  rpc GetInstructions(GetInstructionsRequest) returns (GetInstructionsResponse) {
    option (google.api.http) = {
      get: "/api/v1/agents/{agent_id}/instructions"
    };
  }

  // SubmitInstructionResult submits the result of a completed instruction
  rpc SubmitInstructionResult(SubmitInstructionResultRequest) returns (SubmitInstructionResultResponse) {
    option (google.api.http) = {
      post: "/api/v1/agents/{agent_id}/instructions/{instruction_id}/result"
      body: "result"
    };
  }
}

// AgentStatus represents the current state of an agent
enum AgentStatus {
  AGENT_STATUS_UNSPECIFIED = 0;
  AGENT_STATUS_ACTIVE = 1;
  AGENT_STATUS_INACTIVE = 2;
}

// PortState represents the operational state of a NIC port
enum PortState {
  PORT_STATE_UNSPECIFIED = 0;
  PORT_STATE_DOWN = 1;
  PORT_STATE_UP = 2;
  PORT_STATE_TESTING = 3;
}

// PortSpeed represents the link speed of a port
enum PortSpeed {
  PORT_SPEED_UNSPECIFIED = 0;
  PORT_SPEED_1G = 1;
  PORT_SPEED_10G = 10;
  PORT_SPEED_25G = 25;
  PORT_SPEED_40G = 40;
  PORT_SPEED_50G = 50;
  PORT_SPEED_100G = 100;
  PORT_SPEED_200G = 200;
  PORT_SPEED_400G = 400;
}

// MellanoxPort represents a single port on a Mellanox NIC
message MellanoxPort {
  // Port number (1-based)
  int32 number = 1;

  // Port state (up/down)
  PortState state = 2;

  // Link speed in Gbps
  PortSpeed speed = 3;

  // MAC address
  string mac_address = 4;

  // MTU size
  int32 mtu = 5;

  // Port GUID
  string guid = 6;

  // PCI address for this port (e.g., "0000:03:00.1")
  string pci_address = 7;

  // Network interface name (e.g., "ens1f0")
  string interface_name = 8;
}

// MellanoxNIC represents a Mellanox network interface card
message MellanoxNIC {
  // Device name (e.g., "mlx5_0")
  string device_name = 1;

  // PCI address (e.g., "0000:03:00.0")
  string pci_address = 2;

  // Part number / model
  string part_number = 3;

  // Serial number
  string serial_number = 4;

  // Firmware version
  string firmware_version = 5;

  // Number of ports on this NIC
  int32 port_count = 6;

  // Port details
  repeated MellanoxPort ports = 7;

  // PSID (Parameter Set ID)
  string psid = 8;
}

// Agent represents a node agent registered to a cluster
message Agent {
  // Agent-generated UUID (hardware-based identifier)
  string id = 1;

  // Cluster ID this agent belongs to
  string cluster_id = 2;

  // Node hostname
  string hostname = 3;

  // Node IP address
  string ip_address = 4;

  // Agent version
  string version = 5;

  // Agent status
  AgentStatus status = 6;

  // Last registration or update time
  google.protobuf.Timestamp last_seen = 7;

  // Creation timestamp
  google.protobuf.Timestamp created_at = 8;

  // Last update timestamp
  google.protobuf.Timestamp updated_at = 9;

  // Mellanox NICs reported by agent (populated via hardware collection instruction)
  repeated MellanoxNIC network_interfaces = 10;

  // Whether hardware collection has been completed (true even if no NICs found)
  bool hardware_collected = 11;
}

// RegisterAgentRequest contains parameters for registering an agent
message RegisterAgentRequest {
  // Agent-generated UUID (required)
  string id = 1;

  // Cluster ID (required)
  string cluster_id = 2;

  // Node hostname (optional)
  string hostname = 3;

  // Node IP address (optional)
  string ip_address = 4;

  // Agent version (optional)
  string version = 5;
}

// RegisterAgentResponse returns the registered agent
message RegisterAgentResponse {
  Agent agent = 1;
}

// GetAgentRequest contains parameters for retrieving an agent
message GetAgentRequest {
  // ID of the agent to retrieve
  string id = 1;
}

// GetAgentResponse returns the requested agent
message GetAgentResponse {
  Agent agent = 1;
}

// ListAgentsRequest contains parameters for listing agents
message ListAgentsRequest {
  // Optional cluster ID filter
  string cluster_id = 1;
}

// ListAgentsResponse returns a list of agents
message ListAgentsResponse {
  repeated Agent agents = 1;
}

// UnregisterAgentRequest contains parameters for unregistering an agent
message UnregisterAgentRequest {
  // ID of the agent to unregister
  string id = 1;
}

// UnregisterAgentResponse confirms unregistration
message UnregisterAgentResponse {
  // Whether the unregistration was successful
  bool success = 1;
}

// InstructionType defines the type of instruction
enum InstructionType {
  INSTRUCTION_TYPE_UNSPECIFIED = 0;

  // POLL_INTERVAL instructs the agent when to poll next
  INSTRUCTION_TYPE_POLL_INTERVAL = 1;

  // HEALTH_CHECK requests a health status report
  INSTRUCTION_TYPE_HEALTH_CHECK = 2;

  // COLLECT_HARDWARE requests hardware inventory (Mellanox NICs)
  INSTRUCTION_TYPE_COLLECT_HARDWARE = 3;

  // Future instruction types can be added here:
  // INSTRUCTION_TYPE_RUN_COMMAND = 4;
  // INSTRUCTION_TYPE_UPDATE_CONFIG = 5;
  // INSTRUCTION_TYPE_COLLECT_METRICS = 6;
}

// Instruction represents a command or directive from the service to an agent
message Instruction {
  // Unique instruction ID
  string id = 1;

  // Type of instruction
  InstructionType type = 2;

  // Instruction payload (type-specific data as JSON)
  string payload = 3;

  // When the instruction was created
  google.protobuf.Timestamp created_at = 4;
}

// HardwareCollectionResult contains the result of hardware collection
message HardwareCollectionResult {
  // Collected Mellanox NICs
  repeated MellanoxNIC network_interfaces = 1;
}

// HealthCheckResult contains the result of a health check
message HealthCheckResult {
  // Health status
  bool healthy = 1;

  // Optional error message if unhealthy
  string error_message = 2;
}

// InstructionResult represents the result of executing an instruction
message InstructionResult {
  // Type of instruction that was executed
  InstructionType instruction_type = 1;

  // Type-specific result data
  oneof result {
    HardwareCollectionResult hardware_collection = 2;
    HealthCheckResult health_check = 3;
    // Future result types can be added here
  }
}

// GetInstructionsRequest requests pending instructions for an agent
message GetInstructionsRequest {
  // ID of the agent requesting instructions
  string agent_id = 1;
}

// GetInstructionsResponse returns instructions and polling configuration
message GetInstructionsResponse {
  // List of pending instructions to execute
  repeated Instruction instructions = 1;

  // Seconds to wait before the next poll
  // Default behavior: agent should poll after this interval
  int32 poll_interval_seconds = 2;

  // Server timestamp when response was generated
  google.protobuf.Timestamp server_time = 3;
}

// SubmitInstructionResultRequest submits the result of an instruction
message SubmitInstructionResultRequest {
  // ID of the agent submitting the result
  string agent_id = 1;

  // ID of the instruction that was executed
  string instruction_id = 2;

  // Result of the instruction execution
  InstructionResult result = 3;
}

// SubmitInstructionResultResponse confirms receipt of the instruction result
message SubmitInstructionResultResponse {
  // Whether the result was successfully processed
  bool success = 1;

  // Optional message (error details or acknowledgment)
  string message = 2;
}
