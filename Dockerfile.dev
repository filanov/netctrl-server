# Development Dockerfile for netctrl-server
# Used for: building, testing, linting, proto generation

FROM golang:1.23-alpine

LABEL maintainer="netctrl-server"
LABEL description="Development environment with all build tools"

# Install build dependencies
RUN apk add --no-cache \
    git \
    make \
    ca-certificates \
    protobuf-dev \
    bash \
    curl

# Set GOTOOLCHAIN to auto to allow Go to download the required version
ENV GOTOOLCHAIN=auto

# Set working directory
WORKDIR /workspace

# Copy go mod files first and download Go toolchain + dependencies
# This MUST happen before installing tools to ensure they use the correct Go version
COPY go.mod go.sum ./
RUN go mod download

# Install buf for protobuf generation - uses Go 1.25.4
RUN GOTOOLCHAIN=go1.25.4 go install github.com/bufbuild/buf/cmd/buf@v1.47.2

# Install golangci-lint - uses Go 1.25.4
RUN GOTOOLCHAIN=go1.25.4 go install github.com/golangci/golangci-lint/cmd/golangci-lint@v1.62.2

# Verify Go version
RUN go version

# Copy buf configuration (for proto generation)
COPY buf.yaml buf.gen.yaml buf.lock ./

# Default command opens a shell for interactive use
CMD ["/bin/sh"]
